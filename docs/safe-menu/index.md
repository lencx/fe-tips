# Safe Menu

> æœ¬åœ°è·¯å¾„ï¼š`http://localhost:6800/#/safe-menu`


## èƒŒæ™¯

ä¸çŸ¥ä½ æ˜¯å¦é‡åˆ°è¿‡è¿™ç§åœºæ™¯ï¼šå°†é¼ æ ‡æ‚¬åœåœ¨ä¸€ä¸ªèœå•é¡¹æ—¶ï¼Œè¯¥èœå•é¡¹ä¼šæ˜¾ç¤ºå¦ä¸€ä¸ªå­èœå•é¡¹ï¼ˆå³åµŒå¥—èœå•ï¼‰ã€‚ä½†å½“ä½ è¯•å›¾å°†é¼ æ ‡ç§»å…¥å­èœå•æ—¶ï¼Œç»“æœæ•´ä¸ªèœå•éƒ½å…³é—­äº†ï¼Œååˆ†ä»¤äººæ¼ç«ã€‚

![menu-x1](./assets/menu-x1.gif)

åœ¨â€œå®‰å…¨ä¸‰è§’â€æ¦‚å¿µå‡ºç°å‰ï¼Œæœ€å¸¸è§çš„åšæ³•å°±æ˜¯ç»™å­èœå•æ·»åŠ ä¸€ä¸ªå»¶æ—¶ï¼Œä½†å®ƒä¹Ÿå­˜åœ¨è¯¸å¤šé—®é¢˜ï¼Œæ¯”å¦‚åœ¨é¼ æ ‡ç§»åŠ¨æ—¶å“åº”ä¸å¤Ÿè¿…é€Ÿï¼Œä¼šå‡ºç°æ®‹å½±ã€‚

![menu-x2](./assets/menu-x2.gif)

> **å»¶è¿Ÿæ—¶é—´**
>
> æœ€å¤§é—®é¢˜ï¼šæ¯ä¸ªäººçš„é¼ æ ‡ç§»é€Ÿéƒ½ä¸ä¸€æ ·ï¼Œè®¾ç½®å¤šå°‘ ms åˆé€‚ï¼Ÿè®¾ç½®å°äº†ï¼Œæ¥ä¸åŠï¼Œè®¾ç½®å¤§äº†ï¼Œååº”è¿Ÿé’ã€‚è¿™ä¸ªé—®é¢˜åœ¨ä¸€çº§èœå•é¡¹å°‘ï¼ŒäºŒçº§èœå•é¡¹è¶…å¤šæ—¶ä¼šæ›´çªå‡ºã€‚é€šè¿‡é¼ æ ‡ç›´æ¥ç§»åŠ¨åˆ°äºŒçº§èœå•æœ€åº•éƒ¨ï¼Œå’Œé è¿‘ä¸€çº§èœå•çš„ä½ç½®æ—¶ï¼Œè·ç¦»äº§ç”Ÿçš„æ—¶é—´å·®ä¼šæ›´æ˜æ˜¾ã€‚

## Safe Triangle

å¦‚æœå®ƒæ˜¯ä½ ä¸€ç›´åœ¨åŠªåŠ›åº”å¯¹çš„ç”¨æˆ·ä½“éªŒæŒ‘æˆ˜ï¼Œé‚£ä¹ˆä¸€ä¸ªåä¸ºâ€œå®‰å…¨ä¸‰è§’â€ï¼ˆsafe triangleï¼‰çš„æ¦‚å¿µåˆ™è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªæ–°æƒ³æ³•ï¼Œæ—©åœ¨ 10 å¹´å‰ï¼Œäºšé©¬é€Šï¼ˆAmazonï¼‰å°±åœ¨ç”µå•†ç½‘ç«™çš„å¤§å‹ä¸‹æ‹‰èœå•ä¸Šæ™®åŠäº†å®ƒï¼ŒBen Kamens æ›¾å†™è¿‡ä¸€ç¯‡æ–‡ç«  [Breaking down Amazonâ€™s mega dropdown](https://bjk5.com/post/44698559168/breaking-down-amazons-mega-dropdown)ï¼Œå¯¹å…¶è¿›è¡Œå‰–æã€‚åœ¨é‚£ä¸ªå¹´ä»£ï¼Œå°±åƒæ˜¯é»‘é­”æ³•ä¸€æ ·ï¼Œå› ä¸ºå®ƒæ¯”ä½¿ç”¨å»¶æ—¶ç­–ç•¥ååº”è¦å¿«ä¸Šè®¸å¤šã€‚

![safe-3-menu](./assets/safe-3-menu.gif)

### äºšé©¬é€Šèœå• vs å»¶æ—¶èœå•

äºšé©¬é€Šä¸‹æ‹‰èœå•å¿«é€Ÿåˆ‡æ¢

![amazon-fast-menu](./assets/amazon-fast-menu.gif)

åŠ å…¥å»¶æ—¶çš„æ™®é€šä¸‹æ‹‰èœå•ï¼Œæ˜¾ç¤ºåˆ™è¦æ…¢ä¸Šè®¸å¤š

![other-slow-menu](./assets/other-slow-menu.gif)

### äºšé©¬é€Šæ–¹æ¡ˆ

å…‰æ ‡ä»äºšé©¬é€Šçš„ä¸»ä¸‹æ‹‰èœå•ç§»åŠ¨åˆ°å­èœå•å¾ˆå®¹æ˜“ï¼Œå¹¶ä¸”åœ¨èœå•åˆ‡æ¢æ—¶ä¹Ÿååˆ†ä¸æ»‘ï¼Œæ¯«æ— å»¶æ—¶ã€‚å…¶ç§˜è¯€å°±æ˜¯é€šè¿‡æ£€æµ‹å…‰æ ‡è·¯å¾„ä½ç½®ï¼Œå½“å‰é¼ æ ‡ä½ç½®ä¸ä¸‹æ‹‰èœå•çš„å³ä¸Šè§’å’Œå³ä¸‹è§’ä¹‹é—´ç»˜åˆ¶ä¸€ä¸ªä¸‰è§’åŒºåŸŸã€‚ä¸‹ä¸€åˆ»å½“é¼ æ ‡ä»æ­¤åŒºåŸŸï¼ˆå›¾ä¸­è“è‰²åŒºåŸŸï¼‰å¿«é€Ÿåˆ’è¿‡ï¼Œåˆ™ä¼šä½¿å­èœå•ç»§ç»­ä¿æŒæ‰“å¼€çŠ¶æ€ã€‚ä¸€æ—¦ç¦»å¼€æ­¤åŒºåŸŸï¼Œåˆ™ä¼šç«‹å³åˆ‡æ¢èœå•ï¼Œç»™äººçµæ•çš„æ„Ÿæ„Ÿã€‚

![amazon-safe-menu](./assets/amazon-safe-menu.png)

*å…‰æ ‡ç§»åŠ¨åˆ°è“è‰²åŒºåŸŸä¸­ï¼Œå½“å‰æ˜¾ç¤ºçš„å­èœå•å°†ä¿æŒæ‰“å¼€çŠ¶æ€ä¸€æ®µæ—¶é—´*{.woap-alt}

### jQuery æ’ä»¶

[jQuery-menu-aim](https://github.com/kamens/jQuery-menu-aim) æ˜¯ä¸€ä¸ªç”¨äºä¸‹æ‹‰èœå•çš„ jQuery æ’ä»¶ï¼Œå¯ä»¥åŒºåˆ†ç”¨æˆ·å°è¯•å°†é¼ æ ‡æ‚¬åœåœ¨ä¸‹æ‹‰èœå•é¡¹ä¸Šè¿˜æ˜¯å°è¯•å¯¼èˆªåˆ°å­èœå•çš„å†…å®¹ã€‚ä¸Šä¸‹å¯¼èˆªèœå•æ—¶ä¹Ÿå¯ä»¥æ›´å¿«çš„è½¬æ¢ï¼Œè¾¾åˆ°ä¸äºšé©¬é€Šä¸‹æ‹‰èœå•ç±»ä¼¼çš„æ•ˆæœã€‚

![jq-menu](./assets/jq-menu.gif)

ä»£ç ç¤ºä¾‹ï¼š

```js
 $("#menu").menuAim({
     activate: $.noop,  // è¡Œæ¿€æ´»æ—¶è§¦å‘
     deactivate: $.noop  // è¡Œåœç”¨æ—¶è§¦å‘
 });
```

## åº”ç”¨æ¡ˆä¾‹

æ­£æ˜¯å› ä¸ºå®ƒçš„è‰¯å¥½äº¤äº’ä½“éªŒï¼Œæ‰€ä»¥åœ¨å¾ˆå¤šåœ°æ–¹éƒ½èƒ½çœ‹åˆ°å®ƒçš„èº«å½±ã€‚æ¯”å¦‚ Notion èœå•ã€Web ç‰ˆ VS Code èœå•ã€è¿˜æœ‰ macOS çš„ç³»ç»Ÿèœå•ç­‰ç­‰ã€‚

### Notion

Notion åœ¨ 2023.02.25 å‘å¸–è¡¨ç¤ºï¼šç°åœ¨èœå•äº¤äº’æ›´åŠ æµç•…ï¼Œä¸å†å› å…‰æ ‡ç²¾åº¦é—®é¢˜è€Œæ„å¤–æ¶ˆå¤±ã€‚

> A liâ€™l quality-of-life update:
>
> Before, you had to be really precise with your cursor so menus wouldnâ€™t disappear on you. Should feel much more polished now ğŸ«¡

![notion-menu](./assets/notion-menu.gif)

### VS Code

æ‰“å¼€ GitHub çš„ VS Code ç¼–è¾‘å™¨ï¼ˆåœ¨ä»»æ„ github ä»“åº“ä¸‹ï¼ŒæŒ‰ä¸‹ `.` é”®å³å¯å¿«é€Ÿè¿›å…¥ç¼–è¾‘å™¨æ¨¡å¼ï¼‰ï¼Œä¼šå‘ç°å…¶èœå•ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼å®ç°ã€‚

![vscode-menu](./assets/vscode-menu.gif)

### macOS

macOS ä¸€ç›´ä»¥æ³¨é‡ç”¨æˆ·ç»†èŠ‚è€Œé—»åï¼Œå½“ç„¶åœ¨èœå•ä¸Šä¹Ÿä¸ä¼šä¾‹å¤–ã€‚

![macos-menu](./assets/macos-menu.gif)

## å¼€æºç»„ä»¶

è¿™é‡Œä»‹ç»ä¸¤ä¸ªå¼€æºç»„ä»¶åº“ Antd å’Œ Radixï¼Œä¸å¹¸çš„æ˜¯ Antd å¹¶æœªå®ç°æ­¤åŠŸèƒ½ã€‚

### Antd

é˜¿é‡Œå¼€æºçš„ [Antd](https://github.com/ant-design/ant-design) ç®—æ˜¯åœ¨ React ç”Ÿæ€ä¸‹æœ€å¤§çš„ç»„ä»¶åº“ä¹‹ä¸€äº†ï¼Œå½“å‰æœ€æ–°ç‰ˆä¸º `v5.9.4`ã€‚å¯ä»¥ä»ä»¥ä¸‹æ¼”ç¤ºä¸­çœ‹å‡ºï¼Œä¸‹æ‹‰èœå•å¹¶æœªå®ç°æ­¤ä¼˜åŒ–ã€‚

![menu-antd](./assets/menu-antd.gif)

### Radix

[Radix](https://github.com/radix-ui/primitives) ä¸‹æ‹‰èœå•å·²å®ç°æ­¤ä¼˜åŒ–ã€‚

![menu-radix](./assets/menu-radix.gif)

## å®ç°åŸç†

è¿™ç§æ–¹æ³•çš„ä¸¤ä¸ªå…³é”®è¦ç´ æ˜¯ä½¿ç”¨ `SVG` å’Œ CSS `pointer-events` å±æ€§æ¥åˆ›å»ºä¸€ä¸ªæ‰€è°“çš„â€œå®‰å…¨åŒºåŸŸâ€ï¼ˆsafe areaï¼‰æˆ–â€œå®‰å…¨ä¸‰è§’â€ï¼ˆsafe triangleï¼‰ï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·åœ¨å°è¯•å¯¼èˆªåˆ°å­èœå•æ—¶æ„å¤–å…³é—­å®ƒã€‚åŸºæœ¬æ€è·¯å’Œå®ç°æ­¥éª¤å¦‚ä¸‹ï¼š

### Step 1

> é¼ æ ‡æ‚¬åœï¼ˆMouse Enter and Leaveï¼‰

é¼ æ ‡æ‚¬åœåœ¨åŒ…å«åµŒå¥—å…ƒç´ çš„èœå•é¡¹ï¼ˆç»„ä»¶ SafeAreaOptionï¼‰ä¸Šæ—¶ï¼Œè§¦å‘ä¸€ä¸ª `onMouseEnter` å›è°ƒæ¥æ‰“å¼€åµŒå¥—èœå•ã€‚å½“é¼ æ ‡ç¦»å¼€å…ƒç´ åŠå…¶å­å…ƒç´ æ—¶ï¼Œ`onMouseLeave` å›è°ƒè´Ÿè´£å…³é—­å­èœå•ã€‚

```tsx
const SafeAreaOption = () => {
  const [open, setOpen] = useState(false);
  const parent = useRef<HTMLLIElement | null>(null);
  const child = useRef<HTMLDivElement | null>(null);

  const getTop = useMemo(() => {
    const height = child.current?.offsetHeight;
    return height ? `-${height / 2 - 15}px` : 0;
  }, [child]);

  return (
    <li
      ref={parent}
      className="relative"
      onMouseEnter={() => setOpen(true)}
      onMouseLeave={() => setOpen(false)}
    >
      <MenuPlaceholder />

      {open && parent.current && child.current && (
        <SafeArea anchor={parent.current} submenu={child.current} />
      )}

      <div
        className="absolute"
        style={{
          visibility: open ? 'visible' : 'hidden',
          left: parent.current?.offsetWidth || 0,
          top: getTop,
        }}
        ref={child}
      >
        <ul>
          {Array.from({ length: 6 }).map((_, idx) => <li key={+idx}>Option {idx + 1}</li>)}
        </ul>
      </div>
    </li>
  );
};
```

### Step 2

> ç»˜åˆ¶ SVG

ä½¿ç”¨ SVG ç»˜åˆ¶å®‰å…¨ä¸‰è§’å½¢ï¼ˆç»„ä»¶ SafeAreaï¼‰ã€‚å½“åµŒå¥—èœå•æ‰“å¼€æ—¶ï¼Œå°† SVG åˆ›å»ºä¸ºä¸å¯è§ä½†å­˜åœ¨çš„å­å…ƒç´ ï¼Œä¸ç”¨æˆ·è¿›è¡Œäº¤äº’ï¼ˆæ— æ„è¯†ï¼‰ã€‚éœ€è¦ç¡®ä¿ SVG æ˜¯çŸ©å½¢ï¼Œå…¶é«˜åº¦ç­‰äºåµŒå¥—èœå•çš„é«˜åº¦ï¼Œå®½åº¦ç­‰äºå…‰æ ‡ä¸åµŒå¥—èœå•ä¹‹é—´çš„è·ç¦»ã€‚åªè¦é¼ æ ‡æ‚¬åœåœ¨ SVG å…ƒç´ ä¸Šï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æŸäº›ä¸œè¥¿æ¥ç»´æŠ¤åµŒå¥—èœå•çš„æ‰“å¼€çŠ¶æ€ã€‚

<img width="480" alt="safe-triangle-safe-area-1" src="./assets/safe-triangle-safe-area-1.png">

> æŒ‡é’ˆäº‹ä»¶ï¼ˆPointer Eventsï¼‰

åˆ›å»ºä¸€ä¸ªé¢„æœŸè·¯å¾„ï¼ˆé€šå¸¸æ˜¯ä¸‰è§’å½¢ï¼‰æ¥è¿æ¥ç”¨æˆ·çš„å…‰æ ‡å’Œå­èœå•ï¼Œåªè¦å…‰æ ‡ä½äº SVG å…ƒç´ ä¸Šå°±ä¿æŒå­èœå•çš„æ‰“å¼€çŠ¶æ€ã€‚

<img width="400" alt="safe-triangle-pointer-events" src="./assets/safe-triangle-pointer-events.png">

> å®‰å…¨ä¸‰è§’ï¼ˆSafe Triangleï¼‰

ä¸‰è§’å½¢æ˜¯ SVG çš„å”¯ä¸€è·¯å¾„å…ƒç´ ï¼Œå¿…é¡»è®¾ç½® CSS çš„ `pointer-events` å±æ€§ä¸º noneï¼Œå¹¶ä¸”åœ¨è·¯å¾„å…ƒç´ ä¸­è®¾ç½® `pointer-events` ä¸º autoã€‚è¿™æ ·åšæ˜¯ä¸ºäº†åœ¨äº‹ä»¶æ¥è‡ªè·¯å¾„å…ƒç´ â€œå®‰å…¨ä¸‰è§’å½¢â€æ—¶é˜»æ­¢ä¼ æ’­äº‹ä»¶ï¼Œè€Œå½“äº‹ä»¶æ¥è‡ª SVG çš„å…¶ä»–åŒºåŸŸæ—¶ä¸é˜»æ­¢ã€‚

<img width="400" alt="safe-triangle-path-points" src="./assets/safe-triangle-path-points.png">

```tsx
import useMousePosition from './useMousePosition';

interface SafeAreaProps {
  anchor: HTMLLIElement;
  submenu: HTMLDivElement;
}

export default function SafeArea({ submenu }: SafeAreaProps) {
  const { x: mouseX, y: mouseY } = useMousePosition();

  const {
    // width: submenuWidth,
    height: submenuHeight,
    x: submenuX,
    y: submenuY
  } = submenu.getBoundingClientRect();

  const svgWidth = submenuX - mouseX + 4;
  const svgHeight = submenuHeight;

  return (
    <svg
      style={{
        position: 'fixed',
        width: svgWidth,
        height: submenuHeight,
        pointerEvents: 'none',
        zIndex: 2,
        top: submenuY,
        left: mouseX - 2
      }}
      id="svg-safe-area"
    >
      {/* çŸ©å½¢åŒºåŸŸ */}
      <path
        pointerEvents="none"
        width="100%"
        height="100%"
        fill="rgba(187,39,38,0.05)"
        d={`M 0,0 L ${svgWidth},0 L ${svgWidth},${svgHeight} L 0,${svgHeight} z`}
      />
      {/* ä¸‰è§’å®‰å…¨åŒºåŸŸ */}
      <path
        pointerEvents="auto"
        stroke="red"
        strokeWidth="0.4"
        fill="rgba(114,140,89,0.3)"
        d={`M 0, ${mouseY-submenuY}
          L ${svgWidth},${svgHeight}
          L ${svgWidth},0 z`}
      />
    </svg>
  );
}
```

```tsx
/**
 * â¤ï¸ From:
 * https://www.joshwcomeau.com/snippets/react-hooks/use-mouse-position/
 *
 */
import { useState, useEffect } from 'react';

export default function useMousePosition() {
  const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 });

  useEffect(() => {
    const updateMousePosition = (ev: MouseEvent) => {
      setMousePosition({ x: ev.clientX, y: ev.clientY });
    };
    window.addEventListener("mousemove", updateMousePosition);

    return () => {
      window.removeEventListener("mousemove", updateMousePosition);
    };
  }, []);

  return mousePosition;
}
```

æ–‡ä¸­å±•ç¤ºçš„ä»£ç ç¤ºä¾‹è¿‡äºç®€å•ï¼Œå¹¶ä¸è¶³ä»¥è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä¾‹å¦‚å½“ç”¨æˆ·é¼ æ ‡æ–œå‘ç§»åŠ¨è§¦æ‘¸åˆ°å¦ä¸€ä¸ªèœå•é¡¹çš„é—®é¢˜ï¼Œå¯èƒ½éœ€è¦å¯¹ SVG è¿›è¡Œä¸åŒå½¢çŠ¶çš„è°ƒæ•´ã€‚ç»æµ‹è¯•ï¼Œå¼¯æ›²çš„è·¯å¾„å¾€å¾€èƒ½å¤Ÿè·å¾—æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚æ‰€ä»¥åˆ›å»ºä¸€ä¸ªä¾èµ–äºé¼ æ ‡æ‚¬åœæ¥æ˜¾ç¤ºåµŒå¥—èœå•çš„è§£å†³æ–¹æ¡ˆè¿œæ¯”æƒ³è±¡ä¸­è¦å¤æ‚ã€‚

![context-menu-safe-area-paths](./assets/context-menu-safe-area-paths.gif)

å®Œæ•´ä»£ç å·²æ•´ç†åˆ° [lencx/fe-tips](https://github.com/lencx/fe-tips) ä»“åº“ï¼Œå¯è‡ªè¡Œè·å–ä»£ç ã€‚

![menu-demo](./assets/menu-demo.gif)

> å‚è€ƒé“¾æ¥ï¼š
> Better Context Menus With Safe Triangles: https://www.smashingmagazine.com/2023/08/better-context-menus-safe-triangles